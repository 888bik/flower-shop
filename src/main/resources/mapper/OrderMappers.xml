<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bik.flower_shop.mapper.CouponMapper">

    <!-- 查询用户领取的优惠券 -->
    <select id="selectUserCoupons" resultType="com.bik.flower_shop.pojo.dto.UserCouponDTO">
        SELECT uc.id                                AS id,
               c.id                                 AS couponId,
               c.name,
               c.type,
               c.value,
               c.min_price                          AS minPrice,
               c.total,
               uc.used,
               c.start_time                         AS startTime,
               c.end_time                           AS endTime,
               c.sort,
               c.`desc`                             AS description,
               '全场商品可用'                       AS scope,
               CONCAT(
                       FROM_UNIXTIME(c.start_time, '%Y-%m-%d'),
                       ' ～ ',
                       FROM_UNIXTIME(c.end_time, '%Y-%m-%d')
               )                                    AS time,
               TRUE                                 AS received,
               (c.total - IFNULL(ucCount.count, 0)) AS stock
        FROM coupon_user uc
                 INNER JOIN coupon c ON uc.coupon_id = c.id
                 LEFT JOIN (SELECT coupon_id, COUNT(*) AS count
                            FROM coupon_user
                            GROUP BY coupon_id) ucCount ON c.id = ucCount.coupon_id
        WHERE uc.user_id = #{userId}
        ORDER BY c.sort DESC, c.id DESC
    </select>


</mapper>
